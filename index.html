<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThorPlayer</title>
    <style>
        #player {
            display: none; /* Oculta el video */
        }
        #controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
        }
        button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #info {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }
        #thumbnail {
            margin-right: 20px;
        }
        #thumbnail img {
            width: 100px;
            height: auto;
        }
        #genero-actual {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        #buscar-genero, #buscar-cancion, #playlist-url {
            margin: 20px;
            padding: 10px;
            font-size: 16px;
        }
        #playlist-songs {
            display: none; /* Oculta la lista de canciones hasta que se introduzca un enlace */
            margin-top: 20px;
        }
        #song-list {
            list-style: none;
            padding: 0;
        }
    </style>
</head>
<body>
    <h1>ThorPlayer</h1>
    <h1>Tu radio 24/7</h1>

    <!-- Buscador de géneros -->
    <input type="text" id="buscar-genero" placeholder="Buscar género...">
    
    <!-- Lista de géneros -->
    <select id="generos-list"></select>

    <!-- Buscador de canciones -->
    <input type="text" id="buscar-cancion" placeholder="Buscar canción en YouTube...">
    <button id="buscar-cancion-btn">Buscar canción</button>

    <!-- Campo para URL de la playlist -->
    <input type="text" id="playlist-url" placeholder="Introduce URL de la playlist de YouTube...">
    <button id="cargar-playlist-btn">Cargar Playlist</button>

    <div id="playlist-songs">
        <h2>Canciones de la Playlist</h2>
        <ul id="song-list"></ul>
    </div>

    <div id="player"></div>
    <div id="controls">
        <button id="play">Iniciar</button>
        <button id="pause">Pausar</button>
        <button id="next">Siguiente</button>
    </div>
    <div id="info">
        <div id="thumbnail"></div>
        <div id="title"></div>
    </div>
    <div id="genero-actual">Género actual: <span id="genero"></span></div>

    <script>
        const apiKey = 'AIzaSyDlDBcOeQZZy1jbJEvBChrcpkxSRPLSufE';

        const generos = [
            { genero: 'pop', subgenero: 'pop rock' },
            { genero: 'rock', subgenero: 'hard rock' },
            { genero: 'jazz', subgenero: 'smooth jazz' },
            { genero: 'clásica', subgenero: 'barroca' },
            { genero: 'electrónica', subgenero: 'house' },
            { genero: 'hip hop', subgenero: 'rap' },
            { genero: 'reggae', subgenero: 'dancehall' },
            { genero: 'country', subgenero: 'bluegrass' },
            { genero: 'blues', subgenero: 'rhythm and blues' },
            { genero: 'latina', subgenero: 'salsa' },
            { genero: 'metal', subgenero: 'heavy metal' },
            { genero: 'folk', subgenero: 'folk rock' },
            { genero: 'funk', subgenero: 'disco' },
            { genero: 'gospel', subgenero: 'contemporary gospel' },
            { genero: 'soul', subgenero: 'neo soul' },
            { genero: 'punk', subgenero: 'punk rock' },
            { genero: 'techno', subgenero: 'minimal techno' },
            { genero: 'trance', subgenero: 'progressive trance' },
            { genero: 'dubstep', subgenero: 'brostep' },
            { genero: 'ambient', subgenero: 'dark ambient' },
            { genero: 'indie', subgenero: 'indie pop' },
            { genero: 'k-pop', subgenero: 'k-hip hop' },
            { genero: 'afrobeat', subgenero: 'afro house' },
            { genero: 'swing', subgenero: 'big band' },
            { genero: 'tango', subgenero: 'nuevo tango' },
            { genero: 'opera', subgenero: 'bel canto' },
            { genero: 'ska', subgenero: 'ska punk' },
            { genero: 'grunge', subgenero: 'post-grunge' },
            { genero: 'new wave', subgenero: 'synth-pop' },
            { genero: 'reggaeton', subgenero: 'latin trap' },
            { genero: 'trap', subgenero: 'trap latino' },
            { genero: 'house', subgenero: 'deep house' },
            { genero: 'drum and bass', subgenero: 'liquid funk' },
            { genero: 'garage', subgenero: 'garage rock' },
            { genero: 'emo', subgenero: 'emo pop' },
            { genero: 'industrial', subgenero: 'industrial metal' },
            { genero: 'world', subgenero: 'world fusion' },
            { genero: 'ruso', subgenero: 'música soviética' },
            { genero: 'japonés', subgenero: 'música de los 80s y 90s' },
            { genero: 'ANRI y Miki Matsubara', subgenero: 'música de ANRI y Miki Matsubara' }
        ];
        let generoActual = 0;
        let isPlayerReady = false;
        let player;

        // Función para cargar la lista de géneros en el select
        function cargarListaGeneros() {
            const lista = document.getElementById('generos-list');
            lista.innerHTML = ''; // Limpiar la lista antes de cargarla
            generos.forEach((gen, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${gen.genero} (${gen.subgenero})`;
                lista.appendChild(option);
            });
            lista.value = generoActual; // Asegurarse de que el valor sea el correcto
        }

        // Cambiar género desde el select
        document.getElementById('generos-list').addEventListener('change', (event) => {
            generoActual = parseInt(event.target.value); // Asegurarse de convertir el valor a número
            cambiarGenero();
        });

        // Función para buscar videos musicales en YouTube
        async function buscarVideos(genero, subgenero) {
            let query = `${genero} ${subgenero}`;
            if (genero === 'ANRI y Miki Matsubara') {
                query = 'ANRI Miki Matsubara'; // Busca específicamente por sus nombres
            }

            try {
                const respuesta = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&key=${apiKey}&maxResults=50&videoCategoryId=10`);
                const datos = await respuesta.json();
                return datos.items;
            } catch (error) {
                console.error('Error al buscar videos:', error);
                return [];
            }
        }

        // Función para buscar una canción específica en YouTube
        async function buscarCancion(query) {
            try {
                const respuesta = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&key=${apiKey}&maxResults=1&videoCategoryId=10`);
                const datos = await respuesta.json();
                return datos.items.length > 0 ? datos.items[0] : null;
            } catch (error) {
                console.error('Error al buscar la canción:', error);
                return null;
            }
        }

        // Función para cargar canciones desde una playlist
        async function cargarPlaylist(url) {
            const playlistId = url.split('list=')[1].split('&')[0]; // Extraer el ID de la playlist
            try {
                const respuesta = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&key=${apiKey}&maxResults=50`);
                const datos = await respuesta.json();
                return datos.items;
            } catch (error) {
                console.error('Error al cargar la playlist:', error);
                return [];
            }
        }

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        async function onYouTubeIframeAPIReady() {
            const { genero, subgenero } = generos[generoActual];
            const videos = await buscarVideos(genero, subgenero);
            reproducirVideoAleatorio(videos);
        }

        function cambiarGenero() {
            const { genero, subgenero } = generos[generoActual];
            buscarVideos(genero, subgenero).then(videos => {
                reproducirVideoAleatorio(videos);
            });
        }

        function reproducirVideoAleatorio(videos) {
            if (videos.length === 0) return; // Si no hay videos, no hacer nada

            const indiceAleatorio = Math.floor(Math.random() * videos.length);
            const video = videos[indiceAleatorio];
            const videoId = video.id.videoId;
            const title = video.snippet.title;
            const thumbnailUrl = video.snippet.thumbnails.default.url;

            document.getElementById('title').innerText = title;
            document.getElementById('thumbnail').innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail">`;

            if (player) {
                player.loadVideoById(videoId);
            } else {
                player = new YT.Player('player', {
                    height: '0',
                    width: '0',
                    videoId: videoId,
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        }

        function onPlayerReady(event) {
            isPlayerReady = true;
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                cambiarGenero(); // Cambiar de video al finalizar
            }
        }

        // Evento para el botón de búsqueda de canción
        document.getElementById('buscar-cancion-btn').addEventListener('click', async () => {
            const query = document.getElementById('buscar-cancion').value;
            const cancion = await buscarCancion(query);
            if (cancion) {
                const videoId = cancion.id.videoId;
                const title = cancion.snippet.title;
                const thumbnailUrl = cancion.snippet.thumbnails.default.url;

                document.getElementById('title').innerText = title;
                document.getElementById('thumbnail').innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail">`;

                if (player) {
                    player.loadVideoById(videoId);
                } else {
                    player = new YT.Player('player', {
                        height: '0',
                        width: '0',
                        videoId: videoId,
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange
                        }
                    });
                }
            } else {
                alert('No se encontró ninguna canción.');
            }
        });

        // Evento para el botón de cargar playlist
        document.getElementById('cargar-playlist-btn').addEventListener('click', async () => {
            const url = document.getElementById('playlist-url').value;
            if (url) {
                const canciones = await cargarPlaylist(url);
                const songList = document.getElementById('song-list');
                songList.innerHTML = ''; // Limpiar la lista de canciones
                canciones.forEach(cancion => {
                    const li = document.createElement('li');
                    li.innerText = cancion.snippet.title;
                    li.onclick = () => {
                        const videoId = cancion.snippet.resourceId.videoId;
                        if (player) {
                            player.loadVideoById(videoId);
                        } else {
                            player = new YT.Player('player', {
                                height: '0',
                                width: '0',
                                videoId: videoId,
                                events: {
                                    'onReady': onPlayerReady,
                                    'onStateChange': onPlayerStateChange
                                }
                            });
                        }
                    };
                    songList.appendChild(li);
                });
                document.getElementById('playlist-songs').style.display = 'block'; // Mostrar la lista de canciones
            } else {
                alert('Por favor, introduce una URL válida.');
            }
        });

        // Evento para el botón de pausa
        document.getElementById('pause').addEventListener('click', () => {
            if (player && isPlayerReady) {
                player.pauseVideo();
            }
        });

        // Evento para el botón de iniciar
        document.getElementById('play').addEventListener('click', () => {
            if (player && isPlayerReady) {
                player.playVideo();
            }
        });

        // Evento para el botón de siguiente
        document.getElementById('next').addEventListener('click', async () => {
            const { genero, subgenero } = generos[generoActual];
            const videos = await buscarVideos(genero, subgenero);
            reproducirVideoAleatorio(videos);
        });

        // Cargar lista de géneros al iniciar
        cargarListaGeneros();
    </script>
</body>
</html>
