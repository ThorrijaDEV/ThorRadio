<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThorPlayer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>ThorPlayer</h1>
    <h1>Tu radio 24/7</h1>

    <input type="text" id="fondo-url" placeholder="Introducir URL de la imagen de fondo...">
    <input type="text" id="buscar-genero" placeholder="Buscar género...">
    <select id="generos-list"></select>
    <input type="text" id="buscar-cancion" placeholder="Buscar canción en YouTube...">
    <button id="buscar-cancion-btn">Buscar canción</button>

    <div id="player"></div>
    <div id="controls">
        <button id="play">Iniciar</button>
        <button id="pause">Pausar</button>
        <button id="next">Siguiente</button>
    </div>

    <div id="info">
        <div id="thumbnail"></div>
        <div id="title"></div>
    </div>

    <div id="linea-reproduccion">
        <input type="range" id="progress-bar" value="0" min="0" max="100">
    </div>

    <div id="genero-actual">Género actual: <span id="genero"></span></div>

    <input type="text" id="playlist-url" placeholder="Introducir URL de la playlist...">
    <button id="cargar-playlist-btn">Cargar Playlist</button>
    
    <div id="playlist-songs">
        <h2>Lista de Canciones</h2>
        <ul id="song-list"></ul>
    </div>

    <script>
        const apiKey = 'AIzaSyDlDBcOeQZZy1jbJEvBChrcpkxSRPLSufE';

        const generos = [
            { genero: 'pop', subgenero: 'pop rock' },
            // Agrega los demás géneros...
        ];

        let generoActual = 0;
        let currentPlaylist = [];
        let currentSongIndex = 0;
        let isPlayingFromPlaylist = false;
        let player;

        function cargarListaGeneros() {
            const lista = document.getElementById('generos-list');
            lista.innerHTML = '';
            generos.forEach((gen, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${gen.genero} (${gen.subgenero})`;
                lista.appendChild(option);
            });
            lista.value = generoActual;
        }

        document.getElementById('generos-list').addEventListener('change', (event) => {
            generoActual = parseInt(event.target.value);
            cambiarGenero();
        });

        async function buscarVideos(genero, subgenero) {
            try {
                const respuesta = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${genero}+${subgenero}&key=${apiKey}&maxResults=50`);
                const datos = await respuesta.json();
                return datos.items.filter(video => video.snippet.title.includes("canción") || video.snippet.title.includes("music"));
            } catch (error) {
                console.error('Error al buscar videos:', error);
                return [];
            }
        }

        async function buscarCancion(query) {
            try {
                const respuesta = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&key=${apiKey}&maxResults=1`);
                const datos = await respuesta.json();
                return datos.items.length > 0 ? datos.items[0] : null;
            } catch (error) {
                console.error('Error al buscar la canción:', error);
                return null;
            }
        }

        async function cargarPlaylist(url) {
            try {
                const playlistId = url.split('list=')[1];
                const respuesta = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${playlistId}&key=${apiKey}&maxResults=50`);
                const datos = await respuesta.json();
                currentPlaylist = datos.items;
                isPlayingFromPlaylist = true;
                currentSongIndex = 0;
                document.getElementById('song-list').innerHTML = currentPlaylist.map(song => `<li><a href="#" class="song-link">${song.snippet.title}</a></li>`).join('');
                document.getElementById('playlist-songs').style.display = 'block';
                reproducirCancionDesdePlaylist(currentSongIndex);
            } catch (error) {
                console.error('Error al cargar la playlist:', error);
            }
        }

        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function onYouTubeIframeAPIReady() {
            cambiarGenero();
        }

        function cambiarGenero() {
            const { genero, subgenero } = generos[generoActual];
            buscarVideos(genero, subgenero).then(videos => {
                reproducirVideoAleatorio(videos);
                document.getElementById('genero').innerText = `${genero} (${subgenero})`;
            });
        }

        function reproducirVideoAleatorio(videos) {
            if (videos.length > 0) {
                const videoIndex = Math.floor(Math.random() * videos.length);
                const videoId = videos[videoIndex].id.videoId;
                const title = videos[videoIndex].snippet.title;
                const thumbnailUrl = videos[videoIndex].snippet.thumbnails.default.url;

                document.getElementById('title').innerText = title;
                document.getElementById('thumbnail').innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail">`;

                if (player) {
                    player.loadVideoById(videoId);
                } else {
                    player = new YT.Player('player', {
                        height: '0',
                        width: '0',
                        videoId: videoId,
                        events: {
                            'onReady': onPlayerReady,
                            'onStateChange': onPlayerStateChange
                        }
                    });
                }
            }
        }

        function onPlayerReady(event) {
            event.target.playVideo();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                if (isPlayingFromPlaylist && currentPlaylist.length > 0) {
                    currentSongIndex++;
                    if (currentSongIndex < currentPlaylist.length) {
                        reproducirCancionDesdePlaylist(currentSongIndex);
                    } else {
                        currentSongIndex = 0;
                        reproducirCancionDesdePlaylist(currentSongIndex);
                    }
                } else {
                    cambiarGenero();
                }
            }
        }

        function reproducirCancionDesdePlaylist(index) {
            const cancion = currentPlaylist[index];
            const videoId = cancion.snippet.resourceId.videoId;
            const title = cancion.snippet.title;
            const thumbnailUrl = cancion.snippet.thumbnails.default.url;

            document.getElementById('title').innerText = title;
            document.getElementById('thumbnail').innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail">`;

            if (player) {
                player.loadVideoById(videoId);
            } else {
                player = new YT.Player('player', {
                    height: '0',
                    width: '0',
                    videoId: videoId,
                    events: {
                        'onReady': onPlayerReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        }

        document.getElementById('buscar-cancion-btn').addEventListener('click', async () => {
            const query = document.getElementById('buscar-cancion').value;
            if (query) {
                const cancion = await buscarCancion(query);
                if (cancion) {
                    const videoId = cancion.id.videoId;
                    const title = cancion.snippet.title;
                    const thumbnailUrl = cancion.snippet.thumbnails.default.url;

                    document.getElementById('title').innerText = title;
                    document.getElementById('thumbnail').innerHTML = `<img src="${thumbnailUrl}" alt="Thumbnail">`;

                    if (player) {
                        player.loadVideoById(videoId);
                    } else {
                        player = new YT.Player('player', {
                            height: '0',
                            width: '0',
                            videoId: videoId,
                            events: {
                                'onReady': onPlayerReady,
                                'onStateChange': onPlayerStateChange
                            }
                        });
                    }
                }
            }
        });

        document.getElementById('cargar-playlist-btn').addEventListener('click', async () => {
            const url = document.getElementById('playlist-url').value;
            if (url) {
                await cargarPlaylist(url);
            }
        });

        document.getElementById('play').addEventListener('click', () => {
            if (player) {
                player.playVideo();
            }
        });

        document.getElementById('pause').addEventListener('click', () => {
            if (player) {
                player.pauseVideo();
            }
        });

        document.getElementById('next').addEventListener('click', () => {
            if (isPlayingFromPlaylist) {
                currentSongIndex++;
                if (currentSongIndex < currentPlaylist.length) {
                    reproducirCancionDesdePlaylist(currentSongIndex);
                } else {
                    currentSongIndex = 0;
                    reproducirCancionDesdePlaylist(currentSongIndex);
                }
            } else {
                cambiarGenero();
            }
        });

        document.getElementById('song-list').addEventListener('click', (event) => {
            if (event.target.classList.contains('song-link')) {
                event.preventDefault();
                const index = Array.from(document.getElementById('song-list').children).indexOf(event.target.parentElement);
                reproducirCancionDesdePlaylist(index);
            }
        });

        cargarListaGeneros();
    </script>
</body>
</html>
